#!/usr/bin/bash

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# Exit if any commands fail
set -o errexit

NEXTCLOUD_VERSION="12.0.10"
DESTDIR="/var/www/htdocs/nextcloud"

MUNIN_PLUGINS="
	apache_accesses
	apache_processes
	apache_volume
	httpd_memory
	redis_connected_clients
	redis_per_sec
	redis_used_memory
"

echo "* Remove unused httpd config files"
HTTPD_CONF_RM="httpd-autoindex.conf
httpd-dav.conf
httpd-default.conf
httpd-info.conf
httpd-languages.conf
httpd-manual.conf
httpd-mpm.conf
httpd-multilang-errordoc.conf
httpd-ssl.conf
httpd-userdir.conf
httpd-vhosts.conf"

for CONF_RM in ${HTTPD_CONF_RM}; do
  rm -f /opt/local/etc/httpd/${CONF_RM}
done

echo "* Setup nextcloud"
mkdir -p $DESTDIR/releases

cd $DESTDIR/releases
curl -L -O https://download.qutic.com/src/nextcloud/nextcloud-$NEXTCLOUD_VERSION.tar.bz2
tar xf nextcloud-$NEXTCLOUD_VERSION.tar.bz2
rm nextcloud-$NEXTCLOUD_VERSION.tar.bz2
mv nextcloud nc-$NEXTCLOUD_VERSION
cd nc-$NEXTCLOUD_VERSION
rm -rf config

cd apps
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/calendar.tar.gz
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/contacts.tar.gz
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/tasks.tar.gz
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/deck.tar.gz
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/news.tar.gz
curl -L -O https://download.qutic.com/src/nextcloud/apps-$NEXTCLOUD_VERSION/polls.tar.gz

tar xf calendar.tar.gz
tar xf contacts.tar.gz
tar xf tasks.tar.gz
tar xf deck.tar.gz
tar xf news.tar.gz
tar xf polls.tar.gz

rm calendar.tar.gz
rm contacts.tar.gz
rm tasks.tar.gz
rm deck.tar.gz
rm news.tar.gz
rm polls.tar.gz

cd $DESTDIR
ln -nfs $DESTDIR/releases/nc-$NEXTCLOUD_VERSION current

chown -R www:www "$DESTDIR"

echo "* Change www for cronjobs"
usermod -d "$DESTDIR" -s /usr/bin/bash www

echo "* Activate munin plugins"
/opt/qutic/bin/munin-node-plugins ${MUNIN_PLUGINS}

echo "* Activate redis"
gsed -i \
     -e "s/# maxmemory <bytes>/maxmemory 256mb/" \
     -e "s/# maxmemory-policy noeviction/# maxmemory-policy allkeys-lfu/" \
     -e "s/# unixsocket \/tmp\/redis.sock/unixsocket \/var\/tmp\/redis.sock/" \
     /opt/local/etc/redis.conf

svcadm enable redis

# echo "* Enable ipfilter"
# svcadm enable svc:/network/ipfilter:default

# Clean up
echo "* Cleaning up."
rm /root/customize

# Prepare image for provisioning
sm-prepare-image -y
